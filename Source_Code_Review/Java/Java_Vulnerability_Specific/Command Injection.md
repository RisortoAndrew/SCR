## **3. Regex Patterns for Detection**

Below are regex patterns designed to identify potential command injection points in Java code. These patterns can be used in VS Code's global search functionality.

### **3.1. Usage of `Runtime.getRuntime().exec()`**

**Pattern**:

```regex
Runtime\.getRuntime\(\)\.exec\s*\(\s*([^\)]+)\s*\)
```

**Explanation**:

- Detects calls to `Runtime.getRuntime().exec()` with any arguments.
- Captures the arguments passed to the `exec()` method.

### **3.2. Usage of `ProcessBuilder` with Untrusted Input**

**Pattern**:

```regex
new\s+ProcessBuilder\s*\(\s*([^\)]+)\s*\)
```

**Explanation**:

- Finds instances where `ProcessBuilder` is instantiated.
- Captures the arguments passed to the constructor.

### **3.3. Concatenation of System Commands**

**Pattern**:

```regex
("|\+)\s*\+\s*(request\.getParameter|session\.getAttribute|[^\s\+;]+)\s*\+\s*("|\+)
```

**Explanation**:

- Identifies string concatenations that include user input.
- Useful for detecting dynamic command construction.

### **3.4. Executing Scripts with User Input**

**Pattern**:

```regex
(\.exec|\.start)\s*\(\s*("[^"]*"|\w+)\s*\)
```

**Explanation**:

- Captures calls to methods like `.exec()` or `.start()` with potential script execution.
- Focuses on arguments that may include scripts.

### **3.5. JNI or Native Method Calls**

**Pattern**:

```regex
System\.loadLibrary\s*\(\s*([^\)]+)\s*\)
```

**Explanation**:

- Detects loading of native libraries, which may include unsafe code.
- Useful if the native code executes system commands.

---

<a name="examples"></a>
## **4. Detailed Examples and Explanations**

### **4.1. Vulnerable Code Example: Using `Runtime.exec()` with User Input**

```java
String command = request.getParameter("command");
Runtime.getRuntime().exec(command);
```

**Why It's Vulnerable**:

- The application executes whatever command the user provides without validation.
- An attacker can execute arbitrary system commands.

**Regex Match Explanation**:

- The pattern matches `Runtime.getRuntime().exec(command)` and captures `command` as the argument.

### **4.2. Vulnerable Code Example: `ProcessBuilder` with Untrusted Input**

```java
String filename = request.getParameter("filename");
ProcessBuilder pb = new ProcessBuilder("grep", searchTerm, filename);
pb.start();
```

**Why It's Vulnerable**:

- `filename` comes from user input and is used in a system command.
- An attacker can inject commands or manipulate the file system.

**Regex Match Explanation**:

- The regex identifies the instantiation of `ProcessBuilder` with parameters that may include user input.

### **4.3. Vulnerable Code Example: Concatenation in Command Strings**

```java
String userInput = request.getParameter("dir");
String cmd = "/bin/ls " + userInput;
Runtime.getRuntime().exec(cmd);
```

**Why It's Vulnerable**:

- User input `userInput` is concatenated into the command string.
- Allows command injection via special characters or command separators.

**Regex Match Explanation**:

- The pattern detects the string concatenation involving `userInput`.

### **4.4. Vulnerable Code Example: Executing Scripts with User Input**

```java
String scriptName = request.getParameter("script");
Process proc = Runtime.getRuntime().exec("python " + scriptName);
```

**Why It's Vulnerable**:

- The application runs a script specified by the user.
- An attacker can execute arbitrary scripts or commands.

**Regex Match Explanation**:

- The regex captures the use of `exec()` with concatenated user input.

### **4.5. Vulnerable Code Example: Native Method Invocation**

```java
public native void runCommand(String cmd);

public void execute() {
    String command = request.getParameter("cmd");
    runCommand(command);
}
```

**Why It's Vulnerable**:

- The native method `runCommand` may execute system commands with untrusted input.
- Difficult to analyze as the implementation is in native code.

**Regex Match Explanation**:

- While not directly matched by the provided regex, reviewing native method calls is important.

---

<a name="interpreting-findings"></a>
## **5. Interpreting and Validating Findings**

- **Trace User Input**: Confirm that the data used in system commands originates from untrusted sources like `request.getParameter()`.
- **Analyze Command Construction**: Check how the command string is constructed. Look for concatenation or formatting that includes user input.
- **Review Method Calls**: Ensure that methods like `exec()` and `start()` are not used with unvalidated input.
- **Consider the Execution Context**: Determine if the executed commands run with elevated privileges, which increases the risk.

**Example**:

- If `command` is derived from a hard-coded string or a secure configuration file, the risk is lower.
- If `command` includes any form of user input without proper validation or sanitization, it's a significant vulnerability.

---

<a name="prevention"></a>
## **6. Best Practices for Prevention**

### **6.1. Avoid Executing System Commands with User Input**

- **Recommendation**: Refrain from using `Runtime.exec()` or `ProcessBuilder` with user-supplied data.
- **Alternative**: Use built-in Java APIs or libraries to achieve the desired functionality.

### **6.2. Input Validation and Whitelisting**

- **Validate Input**: Ensure that user input meets expected patterns or values.
- **Whitelisting**: Allow only specific, known-good inputs (e.g., filenames from a predefined list).

**Example**:

```java
List<String> allowedCommands = Arrays.asList("ls", "pwd", "date");
String command = request.getParameter("command");

if (allowedCommands.contains(command)) {
    Runtime.getRuntime().exec(command);
} else {
    throw new IllegalArgumentException("Invalid command");
}
```

### **6.3. Use Parameterized Commands**

- **Avoid Shell Interpretation**: Use the version of `exec()` or `ProcessBuilder` that accepts an array of strings to prevent shell injection.

**Safe Example**:

```java
String userInput = request.getParameter("dir");
String[] cmd = { "/bin/ls", userInput };
Runtime.getRuntime().exec(cmd);
```

- **Note**: Ensure that `userInput` does not contain malicious characters or patterns.

### **6.4. Escape or Sanitize User Input**

- **Sanitize Input**: Remove or encode characters that can alter command structure (e.g., `;`, `&`, `|`).

**Example**:

```java
String userInput = request.getParameter("dir");
userInput = userInput.replaceAll("[;&|]", "");
String cmd = "/bin/ls " + userInput;
Runtime.getRuntime().exec(cmd);
```

- **Caution**: Sanitization can be error-prone. Whitelisting is more secure.